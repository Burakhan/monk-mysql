namespace: monk-mysql

master: 
  defines: runnable
  variables:
    image-tag:
      type: string
      value: <- $image_tag
    rpc-port:
      type: int
      value: 3306
    database_name:
      type: string
      env: MYSQL_DATABASE
      value: <- $mysql_database_name
    database_user:
      env: MYSQL_USER
      type: string
      value: <- $mysql_database_user
    mpassword: 
      env: MYSQL_PASSWORD
      type: string
      value: <- $mysql_database_password
    database_root_password:
      env: MYSQL_ROOT_PASSWORD
      value: <- $mysql_database_root_password
      type: string
    mysql_master_data:
      type: string
      value: mysql-master-data
  containers:
    mysql-master:
      paths:
        - <- `${monk-volume-path}/${mysql_master_data}:/var/lib/mysql`
        - /Users/burakhan/www/monkd/monk-mysql/mysql-master-slave/config/master.cnf:/etc/mysql/conf.d/master.cnf
      ports:
        - <- `0.0.0.0:${rpc-port}:3306`
      image-tag: <- `${image-tag}`
      image: mysql

slave: 
  defines: runnable
  variables:
    image-tag:
      type: string
      value: <- $image_tag
    rpc-port:
      type: int
      value: 3307
    database_name:
      type: string
      env: MYSQL_DATABASE
      value: <- $mysql_database_name
    database_user:
      env: MYSQL_USER
      type: string
      value: <- $mysql_database_user
    mpassword: 
      env: MYSQL_PASSWORD
      type: string
      value: <- $mysql_database_password
    database_root_password:
      env: MYSQL_ROOT_PASSWORD
      value: <- $mysql_database_root_password
      type: string
    mysql_slave_data:
      type: string
      value: mysql-slave-data
  containers:
    mysql-slave:
      paths:
        - <- `${monk-volume-path}/${mysql_slave_data}:/var/lib/mysql`
        - /Users/burakhan/www/monkd/monk-mysql/mysql-master-slave/config/slave.cnf:/etc/mysql/conf.d/slave.cnf
      ports:
        - <- `0.0.0.0:${rpc-port}:3306`
      image-tag: <- `${image-tag}`
      image: mysql

configure: 
  defines: runnable
  variables:
    image-tag:
      type: string
      value: <- $image_tag
    mysql_slave_password:
      type: string
      env: MYSQL_SLAVE_PASSWORD
      value: <- $mysql_database_root_password
    mysql_master_password:
      env: MYSQL_MASTER_PASSWORD
      type: string
      value: <- $mysql_database_root_password
    mysql_repl_user: 
      env: MYSQL_REPLICATION_USER
      type: string
      value: <- $mysql_replication_user
    mysql_repl_password:
      env: MYSQL_REPLICATION_PASSWORD
      value: <- $mysql_database_root_password
      type: string
    mysql_password:
      env: MYSQL_ROOT_PASSWORD
      value: <- $mysql_database_root_password
      type: string
    mysql-master-host:
      env: MYSQL_MASTER_HOST
      type: string
      value: <- get-hostname("monk-mysql/master", "mysql-master") split(".dns.podman") join("")
    mysql-slave-host:
      env: MYSQL_SLAVE_HOST
      type: string
      value: <- get-hostname("monk-mysql/slave", "mysql-slave") split(".dns.podman") join("")
  containers:
    mysql-configure:
      paths:
        - /Users/burakhan/www/monkd/monk-mysql/mysql-master-slave/init.sh:/tmp/init.sh
      bash: chmod +x /tmp/init.sh; bash /tmp/init.sh 
      image-tag: <- `${image-tag}`
      image: mysql